name: Deploy Portfolio Service

on:
  workflow_dispatch:
    inputs:
      portfolio_id:
        description: "Portfolio service id (example: v5c-highrisk-paper)"
        required: true
        default: "v5c-highrisk-paper"
      image_tag:
        description: "Docker image tag"
        required: true
        default: "latest"

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image metadata
        id: meta
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER_LC}/quantlab-v7:${{ github.event.inputs.image_tag }}"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push runtime image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.image }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy compose file to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: deploy/docker-compose.portfolio.yml
          target: ~/quantlab-deploy

      - name: Deploy on VPS over SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image }}
          SERVICE: ${{ github.event.inputs.portfolio_id }}
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: IMAGE,SERVICE,BINANCE_API_KEY,BINANCE_API_SECRET,GHCR_USERNAME,GHCR_TOKEN
          script: |
            set -e
            mkdir -p ~/quantlab-deploy/runtime/logs
            cd ~/quantlab-deploy
            cp ~/quantlab-deploy/deploy/docker-compose.portfolio.yml ~/quantlab-deploy/docker-compose.portfolio.yml
            cat > .env <<EOF
            IMAGE_NAME=${IMAGE%:*}
            IMAGE_TAG=${IMAGE##*:}
            BINANCE_API_KEY=${BINANCE_API_KEY}
            BINANCE_API_SECRET=${BINANCE_API_SECRET}
            EOF
            docker login ghcr.io -u "${GHCR_USERNAME}" -p "${GHCR_TOKEN}"
            docker compose -f docker-compose.portfolio.yml pull ${SERVICE}
            docker compose -f docker-compose.portfolio.yml up -d ${SERVICE}
            docker image prune -f
